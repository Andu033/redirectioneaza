{% extends "base.html" %}


{% block header %}
    <div class="container">
        {% include "components/ngo-header.html" %}
    </div>
{% endblock %}

{# error messages #}
{% set server_error = "Se pare ca am intampinat o eroare pe server. Va rugam incercati din nou." %}
{% set fields_error = "Se pare ca urmatoarele date sunt invalide: " %}

{% block content %}

<div class="container donation-form-container">

    {% if errors %}
        <div class="row">
            <div class="col-xs-12 col-md-6 col-md-offset-3">
                <div class="alert alert-dismissible alert-danger">
                    <button type="button" class="close" data-dismiss="alert">×</button>
                    <strong>Oops! </strong> 
                    {% if errors["fields"] %}
                        {{ fields_error }}
                        <span>
                        {% for error in errors["fields"] %}
                            {{ error + ", " if not loop.last else error }}
                        {% endfor %}
                        </span>
                    {% elif errors["server"] %}
                        {{ server_error }}
                    {% endif %}
                </div>
            </div>
        </div>
    {% endif %}

    <div class="row">
        <div class="col-xs-12 col-md-6 col-md-offset-3">
            {% if ngo.account and ngo.cif %}
            <form id="twopercent" class="form-horizontal" action="{{ ngo.key.id() }}/doilasuta" role="form" method="post">
                <fieldset>
                    <legend>Date personale</legend>
                    <div class="form-group">
                        <div class="col-xs-5">
                            <input type="text" class="form-control text-capitalize" id="nume" value="{{ nume }}" name="nume" placeholder="Nume" maxlength="50" autofocus x-moz-errormessage="Numele este obligatoriu" required />
                        </div>
                        <div class="col-xs-5">
                            <input type="text" class="form-control text-capitalize" id="prenume" value="{{ prenume }}" name="prenume" placeholder="Prenume" maxlength="50" x-moz-errormessage="Prenumele este obligatoriu" required />
                        </div>
                        <div class="col-xs-2">
                            <input type="text" class="form-control text-uppercase text-center" id="tatal" value="{{ tatal }}" name="tatal" maxlength="1" data-toggle="popover" data-placement="right" x-moz-errormessage="" data-content="Initiala tatalui" required />
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-xs-12">
                            <input type="number" class="form-control text-center" id="cnp" value="{{ cnp }}" name="cnp" placeholder="CNP" x-moz-errormessage="CNP-ul este obligatoriu" required />
                        </div>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>Adresa</legend>
                    <div class="form-group">
                        <div class="col-xs-8">
                            <input type="text" class="form-control text-capitalize" id="strada" value="{{ strada }}" name="strada" placeholder="Strada" x-moz-errormessage="Strada este obligatorie" maxlength="70" required />
                        </div>
                        <div class="col-xs-4">
                            <input type="text" class="form-control" id="numar" value="{{ numar }}" name="numar" placeholder="Numar" x-moz-errormessage="Numarul este obligatoriu" maxlength="5" required />
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-xs-3">
                            <input type="text" class="form-control" id="bloc" value="{{ bloc }}" name="bloc" placeholder="Bloc" maxlength="5">
                        </div>
                        <div class="col-xs-3">
                            <input type="text" class="form-control" id="scara" value="{{ scara }}" name="scara" placeholder="Scara" maxlength="5">
                        </div>
                        <div class="col-xs-3">
                            <input type="text" class="form-control" id="etaj" value="{{ etaj }}" name="etaj" placeholder="Etaj" maxlength="5">
                        </div>
                        <div class="col-xs-3">
                            <input type="text" class="form-control" id="ap" value="{{ ap }}" name="ap" placeholder="Ap." maxlength="5">
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-xs-6">
                            <input type="text" class="form-control text-capitalize" id="localitate" value="{{ localitate }}" name="localitate" placeholder="Localitate" x-moz-errormessage="Orasul este obligatoriu" maxlength="40" required />
                        </div>
                        <div class="col-xs-6">
                            {% include "components/county.html" %}
                        </div>
                    </div>
                </fieldset>
                <fieldset>
                    <div class="form-group">
                        <div class="col-lg-12 checkbox">
                            <label class="agree-label" for="agree">
                                <input type="checkbox" name="agree" id="agree" required />
                                Sunt de acord cu <a href="/termeni" target="_blank">Termenii aplicatiei</a> si cu <a href="/politica" target="_blank">Politica de confidentialitate</a>.
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-lg-12">
                            <button id="submit-twopercent-form" type="submit" class="btn btn-primary pull-right">Trimite</button>
                        </div>
                    </div>
                </fieldset>
            </form>
            {% else %}
                <h3>Se pare ca asociatia inca nu si-a activat aceasta forma de donatie.</h3>
            {% endif %}
        </div>
    </div>

    <div id="invalid-form-alert" class="row hidden">
        <div class="col-xs-12 col-md-6 col-md-offset-3">
            <div class="alert alert-danger">
                <strong>Oops! </strong><span>Se pare ca formularul contine campuri invalide.</span>
            </div>
        </div>
    </div>

    {% if not errors and ngo.account and ngo.cif %}
        <div class="row">
            {# info about saved data #}
            <div class="col-xs-12 col-md-6 col-md-offset-3">
                <div class="alert alert-dismissible alert-info">
                    <button type="button" class="close" data-dismiss="alert">×</button>
                    <strong>Nota!</strong> Toate datele de pe aceasta pagina sunt transmise folosind o conexiune sigura. Singurele date salvate separat sunt: numele, prenumele, orasul si judetul.
                </div>
            </div>
        </div>
    {% endif %}

    <div id="second-step-container" class="hidden">
        {% include "components/second-step.html" %}
    </div>
</div>

{% endblock %}

{% block scripts %}
    <script type="text/javascript">
        $(function () {
            $('[data-toggle="popover"]').popover({trigger: "focus"});

            var errorClass = "has-error";
            var invalidFields = {};
            function showError (context) {
                invalidFields[context.id] = true;

                var el = $(context);
                el.parent().addClass(errorClass);
                el.popover({
                    content: "Valoarea acestui camp este invalida.",
                    title: "",
                    placement: "right",
                    trigger: "focus"
                });
            }
            function hideError (context) {
                delete invalidFields[context.id];
                
                var el = $(context);
                el.parent().removeClass(errorClass);
                el.popover('destroy');
            }

            $("#nume, #prenume, #strada, #bloc, #scara, #etaj, #ap, #localitate").on("blur", function(){
                var val = this.value;
                if(!val) return;

                var regex = /^[\w\s.-]+$/gi;
                // if we have no match
                if(!val.match(regex)) {
                    showError(this);
                } else {
                    hideError(this);
                }
            });

            /******************************************************************************/
            /****                            Validare CNP                              ****/
            /******************************************************************************/
            /**
             * Validate CNP ( valid for 1800-2099 )
             *
             * @param string $p_cnp
             * @return boolean
             */
            // copyright https://github.com/cristian-datu/CNP
            function validCNP( p_cnp ) {
                var i=0 , year=0 , hashResult=0 , cnp=[] , hashTable=[2,7,9,1,4,6,3,5,8,2,7,9];
                if( p_cnp.length !== 13 ) { return false; }
                for( i=0 ; i<13 ; i++ ) {
                    cnp[i] = parseInt( p_cnp.charAt(i) , 10 );
                    if( isNaN( cnp[i] ) ) { return false; }
                    if( i < 12 ) { hashResult = hashResult + ( cnp[i] * hashTable[i] ); }
                }
                hashResult = hashResult % 11;
                if( hashResult === 10 ) { hashResult = 1; }
                year = (cnp[1]*10)+cnp[2];
                switch( cnp[0] ) {
                    case 1  : case 2 : { year += 1900; } break;
                    case 3  : case 4 : { year += 1800; } break;
                    case 5  : case 6 : { year += 2000; } break;
                    case 7  : case 8 : case 9 : { year += 2000; if( year > ( parseInt( new Date().getYear() , 10 ) - 14 ) ) { year -= 100; } } break;
                    default : { return false; }
                }
                if( year < 1800 || year > 2099 ) { return false; }
                return ( cnp[12] === hashResult );
            }

            $("#cnp").on("blur", function(){
                var val = this.value;
                if(!val) return;

                if(!validCNP(val)) {
                    showError(this);
                } else {
                    hideError(this);
                }
            });
            
            var invalidFormAlert = $("#invalid-form-alert");
            var submitFormButton = $("#submit-twopercent-form");
            var secondStep = $("#second-step-container");
            $("#twopercent").on("submit", function(ev){
                ev.preventDefault();
                
                $(this).find("input").blur();

                var len = 0;
                for (var o in invalidFields) {
                    len++;
                }

                if( len == 0 ) {
                    // all ok
                    invalidFormAlert.addClass("hidden");
                } else {
                    invalidFormAlert.removeClass("hidden");
                    return;
                }

                // add ajax field
                $('<input />').attr('type', 'hidden')
                    .attr('name', "ajax").attr('value', "true")
                    .appendTo(this);

                submitFormButton.removeClass("btn-primary").addClass("btn-success").attr("disabled", true);
                activateSecondStepForm();
                secondStep.removeClass("hidden");

                $.ajax({
                    url: "{{ ngo.key.id() }}/doilasuta",
                    type: "POST",
                    dataType: "json",
                    data: $(this).serialize(),
                    success: function(data) {

                    },
                    error: function(data) {
                        var response = data.responseJSON;
                        var message = "";
                        if(data.status == 500 || response.server) {
                            message = "{{ server_error }}";
                        } else if(response.fields.length) {
                            message = "{{ fields_error }}";

                            for( var field in response.fields ) {
                                message += response.fields + ", ";
                            }
                            message = message.slice(0, -2);
                        }

                        submitFormButton.addClass("btn-primary").removeClass("btn-success").attr("disabled", false);
                        invalidFormAlert.removeClass("hidden").find("span").text(message);
                        secondStep.addClass("hidden");
                    }
                });
            });


            function activateSecondStepForm() {
                
                var submitButton = $("#second-step-submit-button");
                $("#second-step-form").on("submit", function(ev){
                    ev.preventDefault();

                    var email = $(this).find("#email").val().trim();
                    var telefon = $(this).find("#telefon").val().trim();

                    // if both email and tel are empty, return
                    if(!email && !telefon) {
                        invalidFormAlert.removeClass("hidden").find("span").text("Te rugam sa completezi cu o adresa de email sau un numar de telefon.");
                        return;
                    }

                    // validation
                    var regex = /[\w.-]+@[\w.-]+.\w+/
                    if( email && !regex.test(email) ) {
                        invalidFormAlert.removeClass("hidden").find("span").text("Te rugam sa introduci o adresa de email valida.");
                        return;
                    }

                    if( telefon && (telefon.length != 10 || telefon.slice(0, 2) !== "07") ) {
                        invalidFormAlert.removeClass("hidden").find("span").text("Te rugam sa introduci un numar de telefon mobil valid.");
                        return;
                    }

                    invalidFormAlert.addClass("hidden");
                    submitButton.attr("disabled", true);
    
                    // add ajax field
                    $('<input />').attr('type', 'hidden')
                        .attr('name', "ajax").attr('value', "true")
                        .appendTo(this);

                    $.ajax({
                        url: "{{ ngo.key.id() }}/doilasuta/pas-2",
                        type: "POST",
                        dataType: "json",
                        data: $(this).serialize(),
                        success: function(data) {
                            // redirect to
                            window.location = data.url;
                        },
                        error: function(data) {
                            if(data.response == 500) {
                                var message = "{{ server_error }}";

                            } else {

                                var message = data.responseJSON.message;
                            }

                            submitButton.attr("disabled", false);
                            invalidFormAlert.removeClass("hidden").find("span").text(message);
                        }
                    });
                });
            }
        });
    </script>
{% endblock %}